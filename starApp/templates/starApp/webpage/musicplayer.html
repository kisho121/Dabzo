{% extends 'starApp/layouts/main.html' %}
{% load static %}
{% load custom_filters %}
{% block title %}
Music Player
{% endblock title %}

 
{% block content %}

<div class="contain-body">
    <div class="row sidebar">
        <div class="">
            {% include 'starApp/inc/menu.html' %}
        </div>
   
   
        <div class="main-content" >

            <div class="container-fluid mx-auto bg-secondary playBg mb-1 rounded-2">
                <div class="row">
                    <div class="col-12 col-md-4 col-lg-2 my-1 pb-sm-0 card bgCard mx-auto" style="background-color: rgb(255, 255, 255, 0.9);">
                        <img src="{{ cltnImage.url }}" alt="thumbnail" class="card-img-top border-0 img-thumbnail rounded-3">  
                        <p id="playStatus" class="text-black card-body m-0 py-1  fw-bolder text-center fs-6" style="font-family: serif;">Ready to Play </p>  
                        
                     </div>  
                     <div class="col-12  col-md-8 col-lg-10">
                       <div class="h5 scroll-text text-info fw-bolder pt-1">
                            <span id="player-song-name">{{ songname }}</span>
                        </div>
                        <div class="text-center row d-flex mt-1 justify-content-between mb-2">
                             
                        
                           <div class="d-flex justify-content-center">
                              <p class="text-secondary  p-0 m-0 movieArt" style="font-family: serif;">Movie: </p>
                              <p class="text-white p-0 m-0 movieArt " style="font-family: serif; text-indent: 5px;" > {{movie}}</p>  
                            </div>
                           <div class="d-flex justify-content-center">
                              <p class="text-secondary m-0 p-0 movieArt" style="font-family: serif;">Artist: </p>
                              <p class="text-white p-0 m-0 movieArt  " style="font-family: serif; text-indent: 5px;"> {{artist}}</p>   
                            </div>                         
                                                                  
                        </div>  
                        <hr class="text-light m-0">
                        

                              <div class="music-player-container">
                                <!-- Hidden audio element -->
                                <audio id="audio-id" src="{{ audio }}" type="audio/mpeg"  preload="metadata"></audio>
                                <div class="d-flex justify-content-between text-light mt-1 px-2">
                                    <p id="current-time" class="p-0 m-0" >0:00</p>
                                    <p id="total-time" class="p-0 m-0">{{ duration }}</p>
                                </div>
                                <div class="progress-container mb-1">

                                  <div class="progress-wrapper">
                                    <div class="progress-track">
                                      <div class="progress-fill" id="progress-fill"></div>
                                      <input type="range" id="progress-bar" class="progress-bar" value="0" min="0" max="100" step="0.1">
                                    </div>
                                  </div>
                                </div>
                                
                                
                                <!-- Control buttons -->
                                <div class="player-controls pt-2 m-0">
                                  <button class="mx-0 like-btn {% if is_liked %}liked{% endif %}" 
                                          id="like-btn" 
                                          data-song-id="{{ current_song.id }}" 
                                          title="{% if is_liked %}Remove from Playlist{% else %}Add to Playlist{% endif %}">
                                      <svg width="24" height="24" viewBox="0 0 24 24" 
                                          fill="{% if is_liked %}#ff4757{% else %}none{% endif %}" 
                                          stroke="{% if is_liked %}#ff4757{% else %}currentColor{% endif %}" 
                                          stroke-width="2">
                                          <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>
                                      </svg>
                                  </button>

                                  
                                  <button class="control-btn" id="prev-btn" title="Previous">
                                    <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                                      <path d="M6 6h2v12H6zm3.5 6l8.5 6V6z"/>
                                    </svg>
                                  </button>
                                  
                                  <button class="control-btn play-pause-btn" id="play-pause-btn" title="Play">
                                    <svg id="play-icon" width="32" height="32" viewBox="0 0 24 24" fill="currentColor">
                                      <path d="M8 5v14l11-7z"/>
                                    </svg>
                                    <svg id="pause-icon" width="32" height="32" viewBox="0 0 24 24" fill="currentColor" style="display: none;">
                                      <path d="M6 4h4v16H6zm8 0h4v16h-4z"/>
                                    </svg>
                                  </button>
                                  
                                  <button class="control-btn" id="next-btn" title="Next">
                                    <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                                      <path d="M6 18l8.5-6L6 6v12zM16 6v12h2V6h-2z"/>
                                    </svg>
                                  </button>

                                   <button class="control-btn" id="shuffle-btn" title="Shuffle">
                                      <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                                          <path d="M10.59 9.17L5.41 4 4 5.41l5.17 5.17 1.42-1.41zM14.5 4l2.04 2.04L4 18.59 5.41 20 17.96 7.46 20 9.5V4h-5.5zm.33 9.41l-1.41 1.41 3.13 3.13L14.5 20H20v-5.5l-2.04 2.04-3.13-3.13z"/>
                                      </svg>
                                  </button>
                                </div>
                               
                              </div>
                        </div>  
              </div>
        </div> 



<table class="container-fluid ">
  <thead class="" >
    <tr>
      <th class="py-3 text-info text-center col-1">S.No</th>
      <th  class="py-3 text-center text-info col-2">Image</th>  
      <th  class="py-3 text-info col-4 ps-2 ps-md-5">Song </th>
      <th  class="py-3 text-info col-4">Movie</th>
      <th class="py-3 text-info col-1 text-center" >Like</th>
    </tr>
  </thead>
  <tbody class="table-body">
    {% for list in musicPlayer %}
    <tr class="song-row" data-song-url="{% url 'player' musicName categorytitle artistName list.songname %}">
      <td  class="py-2 text-center">{{ forloop.counter }}</td>
      <td class="py-2 text-center">
        <div class="audio-img-container">
            <a href="{% url 'player' musicName categorytitle artistName list.songname %}">
               <img src="{{list.cltnImage.url|cl_opt:'thumb'}}" alt="image" class="img-icon">
            </a>      
        </div>
     </td>
     
      <td class="song-title py-2 ps-2 ps-md-5">{{ list.songname }}</td>
      
      <td class="py-2 song-title">{{ list.movie }}</td>
      <td class="py-2 text-center">
        <button class="table-like-btn {% if list.id in user_favourites %}liked{% endif %}" 
                data-song-id="{{ list.id }}" 
                title="{% if list.id in user_favourites %}Remove from Playlist{% else %}Add to Playlist{% endif %}">
            <svg width="24" height="24" viewBox="0 0 24 24" 
                fill="{% if list.id in user_favourites %}#ff4757{% else %}none{% endif %}" 
                stroke="{% if list.id in user_favourites %}#ff4757{% else %}currentColor{% endif %}" 
                stroke-width="2">
                <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>
            </svg>
        </button>
      </td>
      
    </tr>
    {% endfor %}
  </tbody>
</table>
{% include 'starApp/inc/footer.html' %}

</div>
</div>
</div>

<style>
  .music-player-container {
    padding: 20px;
    background: rgba(0, 0, 0, 0.3);
    border-radius: 10px;
    margin: 10px 0;
  }
  
  .progress-container {
    margin-bottom: 5px;
  }
  
  .progress-wrapper {
    position: relative;
    width: 100%;
  }
  
  .progress-track {
    position: relative;
    height: 8px;
    background: rgba(255, 255, 255, 0.3);
    border-radius: 5px;
    overflow: hidden;
  }
  
  .progress-fill {
    position: absolute;
    top: 0;
    left: 0;
    height: 100%;
    width: 0%;
    background: linear-gradient(90deg, #17a2b8, #0dcaf0);
    border-radius: 5px;
    transition: width 0.1s linear;
    pointer-events: none;
  }
  
  .time-container {
    display: flex;
    justify-content: space-between;
    padding: 0 5px;
    margin-bottom: 10px;
  }
  
  .time-display {
    color: #fff;
    font-size: 12px;
    font-weight: 500;
  }
  
  .progress-bar {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 8px;
    -webkit-appearance: none;
    appearance: none;
    background: transparent;
    border-radius: 5px;
    outline: none;
    cursor: pointer;
    z-index: 2;
  }
  
  .progress-bar::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 0px;
    height: 0px;
    background: transparent;
    border-radius: 50%;
    cursor: pointer;
  }
  
  .progress-bar::-moz-range-thumb {
    width: 0px;
    height: 0px;
    background: transparent;
    border-radius: 50%;
    cursor: pointer;
    border: none;
  }
  
  .player-controls {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 20px;
    margin: 20px 0;
  }
  
  .control-btn {
    background: rgba(255, 255, 255, 0.2);
    border: 2px solid rgba(255, 255, 255, 0.3);
    border-radius: 50%;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.3s;
    color: #fff;
  }
  
  .play-pause-btn {
    width: 50px;
    height: 50px;
    background: #17a2b8;
    border-color: #17a2b8;
  }
  
  .control-btn:hover {
    background: rgba(255, 255, 255, 0.4);
    transform: scale(1.1);
  }
  
  .play-pause-btn:hover {
    background: #0dcaf0;
    border-color: #0dcaf0;
  }
  
  .control-btn:active {
    transform: scale(0.95);
  }

   #shuffle-btn {
    background: transparent;
    border: none;
  }
  
  #shuffle-btn:hover {
    background: transparent;
    border: none;
    color: #17a2b8;
  }
  
  #shuffle-btn.active {
    color: #17a2b8;
    background: transparent;
    border: none;
  }
  .song-row.active-song {
    background-color: rgba(8, 30, 34, 0.921) !important;
    
  }
  
  .song-row.active-song .song-title {
    color: #17a2b8;
    /* font-weight: bold; */
  }
   .like-btn, .table-like-btn {
    background: transparent;
    border: none;
    cursor: pointer;
    transition: all 0.3s ease;
    color: rgba(255, 255, 255, 0.6);
    padding: 5px;
  }
  
  .like-btn {
    margin-left: 15px;
  }
  
  .like-btn:hover, .table-like-btn:hover {
    transform: scale(1.2);
    color: #ff4757;
  }
  
  .like-btn.liked, .table-like-btn.liked {
    color: #ff4757;
    animation: heartBeat 0.3s ease;
  }
  
  @keyframes heartBeat {
    0%, 100% { transform: scale(1); }
    25% { transform: scale(1.3); }
    50% { transform: scale(1.1); }
  }
  
  .table-like-btn svg {
    pointer-events: none;
  }
  .scroll-text {
    overflow: hidden;
        white-space: nowrap;
        width: 100%;
    }

    .scroll-text span {
        display: inline-block;
        padding-left: 100%;
        animation: marquee 10s linear infinite;
    }

    @keyframes marquee {
        0% { transform: translateX(0); }
        100% { transform: translateX(-100%); }
    }
</style>

{% endblock content %}



{% block scripts %}

<script>
  // CSRF Token helper function - ADD THIS AT THE TOP
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }

  document.addEventListener('DOMContentLoaded', function() {
    const audio = document.getElementById('audio-id');
    const playPauseBtn = document.getElementById('play-pause-btn');
    const playIcon = document.getElementById('play-icon');
    const pauseIcon = document.getElementById('pause-icon');
    const progressBar = document.getElementById('progress-bar');
    const progressFill = document.getElementById('progress-fill');
    const currentTimeDisplay = document.getElementById('current-time');
    const durationTimeDisplay = document.getElementById('total-time');
    const prevBtn = document.getElementById('prev-btn');
    const nextBtn = document.getElementById('next-btn');
    const shuffleBtn = document.getElementById('shuffle-btn');
    const status = document.getElementById('playStatus');
    
    let isPlaying = false;
    let isSeeking = false;
    let isShuffleOn = sessionStorage.getItem('shuffleMode') === 'true' || false;
    
    // Format time helper function
    function formatTime(seconds) {
      if (isNaN(seconds)) return '0:00';
      const mins = Math.floor(seconds / 60);
      const secs = Math.floor(seconds % 60);
      return `${mins}:${secs.toString().padStart(2, '0')}`;
    }
    
    // Play/Pause functionality
    playPauseBtn.addEventListener('click', function() {
      if (isPlaying) {
        audio.pause();
      } else {
        audio.play();
      }
    });
    
    // Update UI when audio plays
    audio.addEventListener('play', function() {
      isPlaying = true;
      playIcon.style.display = 'none';
      pauseIcon.style.display = 'block';
    });
    
    // Update UI when audio pauses
    audio.addEventListener('pause', function() {
      isPlaying = false;
      playIcon.style.display = 'block';
      pauseIcon.style.display = 'none';
    });
    
    // Update progress bar and time as audio plays
    audio.addEventListener('timeupdate', function() {
      if (!isSeeking) {
        const progress = (audio.currentTime / audio.duration) * 100;
        progressBar.value = progress || 0;
        progressFill.style.width = (progress || 0) + '%';
        currentTimeDisplay.textContent = formatTime(audio.currentTime);
      }
    });
    
    // Set duration when metadata loads
    audio.addEventListener('loadedmetadata', function() {
      durationTimeDisplay.textContent = formatTime(audio.duration);
      progressBar.max = 100;
    });
    audio.addEventListener('loadeddata', function() {
        durationTimeDisplay.textContent = formatTime(audio.duration);
    });

    
    // Seek functionality
    progressBar.addEventListener('input', function() {
      isSeeking = true;
      const seekTime = (progressBar.value / 100) * audio.duration;
      progressFill.style.width = progressBar.value + '%';
      currentTimeDisplay.textContent = formatTime(seekTime);
    });
    
    progressBar.addEventListener('change', function() {
      const seekTime = (progressBar.value / 100) * audio.duration;
      audio.currentTime = seekTime;
      isSeeking = false;
    });
    
    // Get all song rows
    const songRows = document.querySelectorAll('.song-row');
    let currentSongIndex = -1;
    
    // Find current song index and highlight it
    songRows.forEach((row, index) => {
      const link = row.querySelector('a');
      if (link && link.href === window.location.href) {
        currentSongIndex = index;
        row.classList.add('active-song');
      }
    });

    // Shuffle functionality
    shuffleBtn.addEventListener('click', function() {
      isShuffleOn = !isShuffleOn;
      sessionStorage.setItem('shuffleMode', isShuffleOn);
      if (isShuffleOn) {
        shuffleBtn.classList.add('active');
        shuffleBtn.title = 'Shuffle: ON';
      } else {
        shuffleBtn.classList.remove('active');
        shuffleBtn.title = 'Shuffle: OFF';
      }
    });
    
    // Restore shuffle button state on page load
    if (isShuffleOn) {
      shuffleBtn.classList.add('active');
      shuffleBtn.title = 'Shuffle: ON';
    }
    // Helper function to get random song index
    function getRandomSongIndex() {
      let randomIndex;
      do {
        randomIndex = Math.floor(Math.random() * songRows.length);
      } while (randomIndex === currentSongIndex && songRows.length > 1);
      return randomIndex;
    }

    // Helper function to navigate to next/prev song
    function navigateToSong(index) {
      const songUrl = songRows[index].querySelector('a').href;
      sessionStorage.setItem('autoplay', 'true');
      window.location.href = songUrl;
    }


    // Make table row clickable
    songRows.forEach(row => {
      row.addEventListener('click', function() {
        const url = this.getAttribute('data-song-url');
        if (url) {
          sessionStorage.setItem('autoplay', 'true');
          window.location.href = url;
        }
      });
      row.style.cursor = "pointer";
    });


    
    // Previous button
    prevBtn.addEventListener('click', function() {
      if (isShuffleOn) {
        const randomIndex = getRandomSongIndex();
        navigateToSong(randomIndex);
      } else if (currentSongIndex > 0) {
        navigateToSong(currentSongIndex - 1);
      } else {
        navigateToSong(songRows.length - 1);
      }
    });
    
    // Next button
    nextBtn.addEventListener('click', function() {
      if (isShuffleOn) {
        const randomIndex = getRandomSongIndex();
        navigateToSong(randomIndex);
      } else if (currentSongIndex < songRows.length - 1) {
        navigateToSong(currentSongIndex + 1);
      } else {
        navigateToSong(0);
      }
    });
    
    // Auto-play next song when current ends
    audio.addEventListener('ended', function() {
      audio.pause();
      audio.currentTime = 0;
      progressBar.value = 0;
      progressFill.style.width = '0%';
      
      sessionStorage.setItem('autoplay', 'true');
      
      if (isShuffleOn) {
        const randomIndex = getRandomSongIndex();
        navigateToSong(randomIndex);
      } else if (currentSongIndex < songRows.length - 1) {
        navigateToSong(currentSongIndex + 1);
      } else {
        navigateToSong(0);
      }
    });
    
    // Check if should autoplay on page load
    if (sessionStorage.getItem('autoplay') === 'true') {
      sessionStorage.removeItem('autoplay');
      audio.play().catch(function(error) {
        console.log('Autoplay prevented:', error);
      });
    }

    audio.addEventListener("play", () =>{
      status.textContent = "Now Playing";
      status.classList.remove("text-warning");
      status.classList.add("text-success");
    });

    audio.addEventListener( "pause", () => {
      status.textContent = "Paused";
      status.classList.remove("text-success");
      status.classList.add("text-info");
    });
    audio.addEventListener( "loadedmetadata", () => {
      status.textContent = "Ready to Play";
      status.classList.remove ("text-success");
      status.classList.add("text-warning");
    });
    
    // FIXED: Toggle Like function with CSRF token and authentication check
    function toggleLike(button, songId) {
      // Check if user is authenticated
      {% if not user.is_authenticated %}
        // alert('Please login to add songs to your playlist');
        showNotification('Please login to add songs to your playlist', 'warning')
        window.location.href = "{% url 'account_login' %}";
        return;
      {% endif %}

      const csrftoken = getCookie('csrftoken');
      
      // Disable button during request
      button.disabled = true;
      button.style.opacity = '0.6';
      
      fetch('{% url "toggle_favourite" %}', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
          'X-CSRFToken': csrftoken  // ADD CSRF TOKEN
        },
        body: `song_id=${songId}`
      })
      .then(response => response.json())
      .then(data => {
        if (data.status === 'success') {
          const svg = button.querySelector('svg');
          
          if (data.liked) {
            button.classList.add('liked');
            svg.setAttribute('fill', '#ff4757');
            showNotification('Added to your playlist!', 'success');
          } else {
            button.classList.remove('liked');
            svg.setAttribute('fill', 'none');
            showNotification('Removed from your playlist', 'info');
          }
          
          // Update all buttons with same song ID
          document.querySelectorAll(`[data-song-id="${songId}"]`).forEach(btn => {
            const btnSvg = btn.querySelector('svg');
            if (data.liked) {
              btn.classList.add('liked');
              btnSvg.setAttribute('fill', '#ff4757');
            } else {
              btn.classList.remove('liked');
              btnSvg.setAttribute('fill', 'none');
            }
          });
        } else {
          showNotification(data.message || 'Error toggling favourite', 'error');
        }
      })
      .catch(error => {
        console.error('Error:', error);
        showNotification('Error toggling favourite. Please try again.', 'error');
      })
      .finally(() => {
        // Re-enable button
        button.disabled = false;
        button.style.opacity = '1';
      });
    }

    // Notification function
    function showNotification(message, type = 'info') {
      const notification = document.createElement('div');
      notification.className = `notification notification-${type}`;
      notification.textContent = message;
      notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: ${type === 'success' ? '#28a745' : type === 'error' ? '#dc3545' : '#17a2b8'};
        color: white;
        padding: 15px 20px;
        border-radius: 5px;
        z-index: 9999;
        box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        animation: slideIn 0.3s ease;
        max-width: 300px;
        font-weight: 500;
      `;
      document.body.appendChild(notification);
      
      setTimeout(() => {
        notification.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => notification.remove(), 300);
      }, 3000);
    }

    // Main like button
    const mainLikeBtn = document.getElementById('like-btn');
    if (mainLikeBtn) {
      mainLikeBtn.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        const songId = this.getAttribute('data-song-id');
        toggleLike(this, songId);
      });
    }
    document.querySelectorAll('.table-like-btn').forEach(btn => {
      btn.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation(); // Prevent row click
        const songId = this.getAttribute('data-song-id');
        toggleLike(this, songId);
      });
    });
  });

  

  // Add notification animations
  const style = document.createElement('style');
  style.textContent = `
    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    
    @keyframes slideOut {
      from { transform: translateX(0); opacity: 1; }
      to { transform: translateX(100%); opacity: 0; }
    }
  `;
  document.head.appendChild(style);
</script>
{% endblock scripts %}
