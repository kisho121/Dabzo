{% extends 'starApp/layouts/main.html' %}
{% load static %}
{% load cloudinary_filters %}

{% block title %}
Music
{% endblock title %}

 
{% block content %}

<div class="contain-body container-fluid row w-100 m-0 p-0 ">
    <div class="">
        {% include 'starApp/inc/menu.html' %}
    </div>
     
    <div class="main-content mx-auto px-0 mx-0">
    
      <div id="demo" class="carousel slide" data-bs-ride="carousel" data-bs-interval="5000">
          <div class="carousel-indicators">
            {% for slide in slides %}
              <button type="button" data-bs-target="#demo" data-bs-slide-to="{{ forloop.counter0 }}" class="{% if forloop.first %} active {% endif %}" aria-current="{% if forloop.first %}true{% else %}false{% endif %}" aria-label="slide{{ forloop.counter}}"></button>
            {% endfor %}
          </div>
          <div class="carousel-inner">
            {% for slide in slides %}
            <div class="carousel-item {% if forloop.first %} active {% endif %}">
                <!-- Optimized carousel images: smaller size, webp format -->
                <img src="{{ slide.carousel_image.url }}" 
                     loading="{% if forloop.first %}eager{% else %}lazy{% endif %}" 
                     class="position-relative caro-img" 
                     alt="{{slide.alt_text}}"
                     width="100%" 
                     height="auto">
            </div>
            {% endfor %}
          </div>
        
          <button class="carousel-control-prev" type="button" data-bs-target="#demo" data-bs-slide="prev">
            <span class="carousel-control-prev-icon" aria-hidden="true"></span>
          </button>
          <button class="carousel-control-next" type="button" data-bs-target="#demo" data-bs-slide="next">
            <span class="carousel-control-next-icon" aria-hidden="true"></span>
          </button>
      </div>
      
      <h2 class="container my-2 text-center language-title">SELECT LANGUAGE</h2>
      
      <div class="container-fluid">
          <div class="row mb-1">
              {% for item in music %}
              <div class="col-12 col-sm-12 col-md-6 col-lg-4 py-lg-2 py-2 langBox">
                <div class="card my-0 audioBox w-100 rounded-3" style="background-color: {% cycle 'orange' 'blue' 'green' 'purple' 'aqua' %};">
                  <a href="{% url 'category' item.musicName %}" class="card-link text-decoration-none">
                    <img class="card-img-top cardimage w-50 rounded-circle" 
                         src="{{ item.musicImage.url|cl_opt:'small' }}" 
                         alt="{{item.musicName}}"
                         loading="lazy"
                         width="150"
                         height="150" />
                      
                      <div class="card-body">
                          <h4 class="textLang float-start">{{ item.musicName }}</h4>
                      </div>
                  </a>
                </div>
              </div>
              {% endfor %}
          </div>
      </div>
      
<!-- ============ NEW GLOBAL TOP 10 MOST LIKED SONGS SECTION ============ -->
<div class="global-top-section container-fluid p-0">
    <div class="section-header text-center">
        <i class="bi bi-trophy text-warning fs-3"></i>
        <h2 class="section-title text-white fw-bolder" style="text-shadow: 1px 1px 1px white; font-family: sans-serif;">TOP 10 LOVED SONGS</h2> 
        <p class="text-muted small">Most loved songs by all users worldwide</p>
    </div>

    {% if global_top_songs %}
    <div class="table-responsive">
        <table class="container-fluid global-top-table">
            <thead>
                <tr>
                    <th class="py-3 text-black text-center col-1">Rank</th>
                    <th class="py-3 text-black text-center col-2">Image</th>  
                    <th class="py-3 text-black col-4 ps-lg-3">Song</th>
                    <th class="py-3 text-black ps-1 col-4">Movie</th>
                    <th class="py-3 text-black col-1 text-center">Count</th>
                </tr>
            </thead>
            <tbody>
                {% for song in global_top_songs %}
                <tr class="clickable-row song-row {% if forloop.counter == 1 %}champion-row{% elif forloop.counter <= 3 %}podium-row{% endif %}" 
                    data-song-id="{{ song.id }}"
                    data-href="{% url 'player' song.categoryModel.musicModel.musickey.musicName song.categoryModel.musicModel.categorytitle song.categoryModel.artistName song.songname %}">
                    
                    <td class="text-center px-0 py-3 rank-cell">
                        {% if forloop.counter == 1 %}
                            <div class="rank-badge champion">
                                <span class="rank-num">1</span>
                                <div class="crown-icon">ðŸ‘‘</div>
                            </div>
                        {% elif forloop.counter == 2 %}
                            <div class="rank-badge runner-up">
                                <span class="rank-num">2</span>
                            </div>
                        {% elif forloop.counter == 3 %}
                            <div class="rank-badge third-place">
                                <span class="rank-num">3</span>
                            </div>
                        {% else %}
                            <div class="rank-number">
                                <span class="number-circle">{{ forloop.counter }}</span>
                            </div>
                        {% endif %}
                    </td>
                    
                    <td class="text-center py-3">
                        <div class="song-image-container">
                            <img 
                              src="{{ song.cltnImage.url|cl_opt:'thumb' }}" 
                              loading="lazy" 
                              alt="{{ song.songname }}" 
                              class="img-icon"
                              width="50"
                              height="50">
                            
                            {% if forloop.counter <= 3 %}
                            <div class="fire-badge">
                                <i class="bi bi-fire fs-6"></i>
                            </div>
                            {% endif %}
                        </div>
                    </td>
                    
                    <td class="ps-3 ps-lg-3 py-3">
                        <div class="song-details">
                            <span class="song-title">{{ song.songname }}</span>
                        </div>
                    </td>
                    
                    <td class="py-3 ps-1">
                        <span class="song-title">{{ song.movie }}</span>
                    </td>
                    
                    <td class="text-center py-3">
                        <div class="like-stats">
                            <div class="like-count-box">
                                <i class="bi bi-heart-fill text-danger"></i>
                                <span class="like-count-num fs-6">{{ song.like_count }}</span>
                            </div>
                            <div class="popularity-bar">
                                <div class="popularity-fill" style="width: {% if forloop.counter == 1 %}100{% else %}{{ song.like_percentage }}{% endif %}%;"></div>
                            </div>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div class="text-center py-3 empty-state">
        <i class="bi bi-music-note-list text-muted" style="font-size: 5rem;"></i>
        <h4 class="text-muted mt-3">No data available yet</h4>
        <p class="text-muted">Start liking songs to build the global top 10!</p>
    </div>
    {% endif %}
</div>
<!-- ============ END NEW GLOBAL TOP 10 SECTION ============ -->

      {% include 'starApp/inc/footer.html' %}
    </div>

</div>



<script>
  // Optimized: Debounced CSRF helper
  const getCookie = (name) => {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    return parts.length === 2 ? parts.pop().split(';').shift() : null;
  };

  // Optimized notification with fade
  function showNotification(message, type = 'info') {
    const colors = { success: '#28a745', error: '#dc3545', info: '#17a2b8' };
    const notification = document.createElement('div');
    notification.textContent = message;
    Object.assign(notification.style, {
      position: 'fixed',
      top: '20px',
      right: '20px',
      background: colors[type],
      color: 'white',
      padding: '15px 20px',
      borderRadius: '5px',
      zIndex: '9999',
      boxShadow: '0 4px 6px rgba(0,0,0,0.3)',
      animation: 'slideIn 0.3s ease',
      maxWidth: '300px',
      fontWeight: '500'
    });
    document.body.appendChild(notification);
    
    setTimeout(() => {
      notification.style.animation = 'slideOut 0.3s ease';
      setTimeout(() => notification.remove(), 300);
    }, 3000);
  }

  // Optimized: Use event delegation for better performance
  document.addEventListener('DOMContentLoaded', function() {
    const table = document.querySelector('.global-top-table');
    if (!table) return;

    // Single event listener for all rows
    table.addEventListener('click', function(e) {
      const row = e.target.closest('.clickable-row');
      if (!row) return;
      
      // Don't navigate if clicking buttons
      if (e.target.closest('.action-btn, .wishlist-toggle-btn')) {
        e.stopPropagation();
        return;
      }
      
      window.location.href = row.dataset.href;
    });
  });

  // Optimized like toggle
  function toggleTableLike(event, button, songId) {
    event.stopPropagation();
    
    {% if not user.is_authenticated %}
      alert('Please login to add songs to your playlist');
      window.location.href = "{% url 'account_login' %}";
      return;
    {% endif %}

    button.disabled = true;
    
    fetch('{% url "toggle_favourite" %}', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded',
        'X-CSRFToken': getCookie('csrftoken')
      },
      body: `song_id=${songId}`
    })
    .then(res => res.json())
    .then(data => {
      if (data.status === 'success') {
        const svg = button.querySelector('svg');
        const isAdded = data.action === 'added';
        
        button.classList.toggle('liked', isAdded);
        svg.setAttribute('fill', isAdded ? '#ff4757' : 'none');
        svg.setAttribute('stroke', isAdded ? '#ff4757' : 'currentColor');
        button.title = isAdded ? 'Remove from Playlist' : 'Add to Playlist';
        
        showNotification(
          isAdded ? 'Added to your playlist!' : 'Removed from your playlist',
          isAdded ? 'success' : 'info'
        );
      } else {
        showNotification(data.message || 'Error toggling favourite', 'error');
      }
    })
    .catch(err => {
      console.error('Error:', err);
      showNotification('Error toggling favourite. Please try again.', 'error');
    })
    .finally(() => {
      button.disabled = false;
    });
  }
</script>

<style>
/* Critical inline CSS only - move rest to external file */
.language-title {
  font-weight: 900;
  text-shadow: 1px 1px 1px aqua;
  color: aqua;
}

@keyframes slideIn {
  from { transform: translateX(400px); opacity: 0; }
  to { transform: translateX(0); opacity: 1; }
}

@keyframes slideOut {
  from { transform: translateX(0); opacity: 1; }
  to { transform: translateX(400px); opacity: 0; }
}
</style>

{% endblock content %}