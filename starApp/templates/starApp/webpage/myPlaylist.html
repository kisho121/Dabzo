{% extends 'starApp/layouts/main.html' %}
{% load static %}
{% load custom_filters %}

{% block title %}My Wishlist{% endblock title %}

{% block content %}

<div class="contain-body">
    
    <div class="container-fluid d-flex justify-content-between mb-0 pb-0">
       
        <img class="float-start playerLogo"  src="{% static 'images/favicon.png' %}" alt="logo" width="100px" >
        <div class="">
            <h2 class="fw-bolder text-center" style="text-shadow: 1px 1px 1px white !important; color: white; font-family: serif;">
                PLAYLIST  
            </h2>
        <!-- <p class=" text-info text-center my-0 py-0 ">( {{ total_count }} song{{ total_count|pluralize }} )</p> -->
            
        </div>
        <div class="float-end" >
            <button type="button" class="btn btn-sm btn-outline-info m-1" onclick="history.back()" data-bs-toggle="tooltip" title="Back"><i class="bi bi-arrow-left fs-6 "></i></button>
            <a href="{% url 'home' %}"><button class="btn btn-sm btn-outline-info m-1" type="button" data-bs-toggle="tooltip" title="Home"><i class="bi bi-house fs-6 "></i></button></a>      
        </div>

    </div>

        <!-- <div class="main-content col-10 col-sm-10 col-md-10 col-lg-11"> -->
        <div class="main-content">   
            <div class="container-fluid">
                

                {% if wishlist_songs %}
                <!-- Music Player -->
                <div class="container-fluid mx-auto bg-secondary playBg mb-3 rounded" id="player-container" style="display: none;">
                    <div class="row">
                        <div class="col-12 col-md-3 col-lg-2 my-1 card">
                            <img id="player-image" src="" alt="" class="card-img-top img-thumbnail">  
                            <h5 id="playStatus" class="text-black card-body fs-6 m-0 py-1 fw-bolder text-center" style="font-family: serif;">Ready to Play</h5>  
                        </div>  
                        <div class="col-12 col-md-9 col-lg-10">
                            <div class="h4 scroll-text text-info fw-bold">
                                <span id="player-song-name"></span>
                            </div>

                            <div class="text-center row d-flex mt-2 justify-content-between">
                                <div class="d-flex justify-content-center">
                                    <p class="text-secondary p-0 m-0 movieArt" >Movie:</p>
                                    <p id="player-movie" class="text-white p-0 m-0 movieArt fw-bold " style="font-family: serif; text-indent: 3px;"></p>  
                                </div>
                                <div class="d-flex justify-content-center">
                                    <p class="text-secondary m-0 p-0 movieArt">Artist:</p>
                                    <p id="player-artist" class="text-white p-0 m-0 movieArt fw-bold" style="font-family: serif; text-indent: 3px;"></p>   
                                </div>
                                <!-- <div class="col-4">
                                    <p class="text-light m-0 p-0 movieArt">Duration:</p>
                                    <p id="player-duration" class="text-info p-0 m-0 movieArt fw-bold" style="font-family: serif;"></p>   
                                </div> -->
                            </div>  
                            <hr class="text-light m-0">

                            <div class="music-player-container">
                                <audio id="audio-player" preload="metadata"></audio>
                                <div class="d-flex justify-content-between text-light mt-1 px-2">
                                    <p id="current-time" class="p-0 m-0">0:00</p>
                                    <p id="total-time" class="p-0 m-0">0:00</p>
                                </div>
                                <div class="progress-container mb-1">
                                    <div class="progress-wrapper">
                                        <div class="progress-track">
                                            <div class="progress-fill" id="progress-fill"></div>
                                            <input type="range" id="progress-bar" class="progress-bar" value="0" min="0" max="100" step="0.1">
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="player-controls pt-2 m-0">
                                    <button class="control-btn" id="loop-btn" title="Loop: OFF">
                                        <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                                            <path d="M7 7h10v3l4-4-4-4v3H5v6h2V7zm10 10H7v-3l-4 4 4 4v-3h12v-6h-2v4z"/>
                                        </svg>
                                    </button>
                                    
                                    <button class="control-btn" id="prev-btn" title="Previous">
                                        <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                                            <path d="M6 6h2v12H6zm3.5 6l8.5 6V6z"/>
                                        </svg>
                                    </button>
                                    
                                    <button class="control-btn play-pause-btn" id="play-pause-btn" title="Play">
                                        <svg id="play-icon" width="32" height="32" viewBox="0 0 24 24" fill="currentColor">
                                            <path d="M8 5v14l11-7z"/>
                                        </svg>
                                        <svg id="pause-icon" width="32" height="32" viewBox="0 0 24 24" fill="currentColor" style="display: none;">
                                            <path d="M6 4h4v16H6zm8 0h4v16h-4z"/>
                                        </svg>
                                    </button>
                                    
                                    <button class="control-btn" id="next-btn" title="Next">
                                        <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                                            <path d="M6 18l8.5-6L6 6v12zM16 6v12h2V6h-2z"/>
                                        </svg>
                                    </button>

                                    <button class="control-btn" id="shuffle-btn" title="Shuffle">
                                        <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                                            <path d="M10.59 9.17L5.41 4 4 5.41l5.17 5.17 1.42-1.41zM14.5 4l2.04 2.04L4 18.59 5.41 20 17.96 7.46 20 9.5V4h-5.5zm.33 9.41l-1.41 1.41 3.13 3.13L14.5 20H20v-5.5l-2.04 2.04-3.13-3.13z"/>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                        </div>  
                    </div>
                </div>

                <!-- Song Table -->
                <table class="container-fluid">
                    <thead>
                        <tr>
                            <th class="py-3 text-info text-center col-1">S.No</th>
                            <th class="py-3 text-center text-info col-2">Image</th>
                            <th class="py-3 text-info col-4 ps-1 ps-lg-5">Song</th>
                            <th class="py-3 text-info col-4 ps-1">Movie</th>
                            <!-- <th class="py-3 text-info col-2">Artist</th>
                            <th class="py-3 text-info col-1 text-center">Duration</th> -->
                            <th class="py-3 text-info col-1 text-center">Remove</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for song in wishlist_songs %}
                        <tr class="wishlist-row song-row" 
                            data-song-id="{{ song.id }}"
                            data-song-url="{{ song.audio }}"
                            data-song-name="{{ song.songname }}"
                            data-movie="{{ song.movie }}"
                            data-artist="{{ song.artist }}"
                            data-duration="{{ song.duration }}"
                            data-image="{{ song.cltnImage.url }}"
                            style="cursor: pointer;">
                            <td class="py-2 text-center text-light">{{ forloop.counter }}</td>
                            <td class="py-2 text-center">
                                <div class="audio-img-container">
                                   <img src="{{song.cltnImage.url|cl_opt:'thumb'}}" alt="" class="img-icon">          
                                </div>
                            </td>
                            <td class="text-light song-title ps-1 ps-lg-5 py-2 ">{{ song.songname }}</td>
                            <td class="py-2 ps-1 song-title">{{ song.movie }}</td>
                            <!-- <td class="py-3 text-light">{{ song.artist }}</td>
                            <td class="py-3 text-center text-light">{{ song.duration }}</td> -->
                            <td class="py-2 text-center">
                                <button class="btn btn-sm btn-outline-danger remove-btn" 
                                        data-song-id="{{ song.id }}"
                                        title="Remove from wishlist">
                                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                                    </svg>
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <div class="text-center py-5">
                    <svg width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="#6c757d" stroke-width="1.5" class="mb-3">
                        <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>
                    </svg>
                    <h4 class="text-muted">Your wishlist is empty</h4>
                    <p class="text-muted">Start adding songs you love to see them here!</p>
                    <a href="{% url 'audio' %}" class="btn btn-info mt-3">Browse Music</a>
                </div>
                {% endif %}
            </div>

         
        </div>
    
</div>

<div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content bg-dark border-danger">
      <div class="modal-header border-danger">
        <h5 class="modal-title text-light" id="deleteModalLabel">
            <i class="bi bi-exclamation-triangle-fill text-danger me-2"></i>
            Remove from Playlist
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body text-light">
        <p class="mb-2">Are you sure you want to remove</p>
        <!-- <p class="text-info fw-bold mb-2" id="songToDelete"></p> -->
        
      </div>
      <div class="modal-footer border-danger">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-danger" id="confirmDeleteBtn">
            <i class="bi bi-trash fs-6 me-1"></i> Remove
        </button>
      </div>
    </div>
  </div>
</div>
{% include 'starApp/inc/footer.html' %}

<style>
    .wishlist-row:hover {
        background-color: rgba(23, 162, 184, 0.1);
    }
    
    .wishlist-row.active-song {
        background-color: rgba(8, 30, 34, 0.921) !important;
    }
    
    .wishlist-row.active-song .song-title {
        font-weight: bold;
        color: #17a2b8 !important;
    }
    
    .remove-btn {
        transition: all 0.3s ease;
    }
    
    .remove-btn:hover {
        transform: scale(1.1);
    }

    .music-player-container {
        padding: 20px;
        background: rgba(0, 0, 0, 0.3);
        border-radius: 10px;
        margin: 10px 0;
    }

    .progress-container {
        margin-bottom: 5px;
    }

    .progress-wrapper {
        position: relative;
        width: 100%;
    }

    .progress-track {
        position: relative;
        height: 8px;
        background: rgba(255, 255, 255, 0.3);
        border-radius: 5px;
        overflow: hidden;
    }

    .progress-fill {
        position: absolute;
        top: 0;
        left: 0;
        height: 100%;
        width: 0%;
        background: linear-gradient(90deg, #17a2b8, #0dcaf0);
        border-radius: 5px;
        transition: width 0.1s linear;
        pointer-events: none;
    }

    .progress-bar {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 8px;
        -webkit-appearance: none;
        appearance: none;
        background: transparent;
        border-radius: 5px;
        outline: none;
        cursor: pointer;
        z-index: 2;
    }

    .progress-bar::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 0px;
        height: 0px;
        background: transparent;
        border-radius: 50%;
        cursor: pointer;
    }

    .progress-bar::-moz-range-thumb {
        width: 0px;
        height: 0px;
        background: transparent;
        border-radius: 50%;
        cursor: pointer;
        border: none;
    }

    .player-controls {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 20px;
        margin: 20px 0;
    }

    .control-btn {
        background: rgba(255, 255, 255, 0.2);
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        width: 50px;
        height: 50px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s;
        color: #fff;
    }

    .play-pause-btn {
        width: 60px;
        height: 60px;
        background: #17a2b8;
        border-color: #17a2b8;
    }

    .control-btn:hover {
        background: rgba(255, 255, 255, 0.4);
        transform: scale(1.1);
    }

    .play-pause-btn:hover {
        background: #0dcaf0;
        border-color: #0dcaf0;
    }

    .control-btn:active {
        transform: scale(0.95);
    }

    #shuffle-btn {
        background: transparent;
        border: none;
    }

    #shuffle-btn:hover {
        background: transparent;
        border: none;
        color: #17a2b8;
    }

    #shuffle-btn.active {
        color: #17a2b8;
        background: transparent;
        border: none;
    }
    .scroll-text {
    overflow: hidden;
        white-space: nowrap;
        width: 100%;
    }

    .scroll-text span {
        display: inline-block;
        padding-left: 100%;
        animation: marquee 10s linear infinite;
    }

    @keyframes marquee {
        0% { transform: translateX(0); }
        100% { transform: translateX(-100%); }
    }
    #loop-btn {
        background: transparent;
        border: none;
    }

    #loop-btn:hover {
        background: transparent;
        border: none;
        color: #17a2b8;
    }

    #loop-btn.active {
        color: #17a2b8;
        background: transparent;
        border: none;
    }

</style>



<script>
// CSRF Token function - ADD THIS AT THE TOP
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

document.addEventListener('DOMContentLoaded', function() {
    const audio = document.getElementById('audio-player');
    const playerContainer = document.getElementById('player-container');
    const playPauseBtn = document.getElementById('play-pause-btn');
    const playIcon = document.getElementById('play-icon');
    const pauseIcon = document.getElementById('pause-icon');
    const progressBar = document.getElementById('progress-bar');
    const progressFill = document.getElementById('progress-fill');
    const currentTimeDisplay = document.getElementById('current-time');
    const totalTimeDisplay = document.getElementById('total-time');
    const prevBtn = document.getElementById('prev-btn');
    const nextBtn = document.getElementById('next-btn');
    const shuffleBtn = document.getElementById('shuffle-btn');
    const status = document.getElementById('playStatus');

    const loopBtn = document.getElementById('loop-btn');
    let isLoopOn = sessionStorage.getItem('loopMode') === 'true' || false;
    
    // Restore loop state
    if (isLoopOn) {
        loopBtn.classList.add('active');
        loopBtn.title = 'Loop: ON';
        audio.loop = true;
    }

    const songRows = document.querySelectorAll('.song-row');
    let currentSongIndex = -1;
    let isPlaying = false;
    let isSeeking = false;
    let isShuffleOn = sessionStorage.getItem('shuffleMode') === 'true' || false;

    // Restore shuffle state
    if (isShuffleOn) {
        shuffleBtn.classList.add('active');
        shuffleBtn.title = 'Shuffle: ON';
    }

    function formatTime(seconds) {
        if (isNaN(seconds)) return '0:00';
        const mins = Math.floor(seconds / 60);
        const secs = Math.floor(seconds % 60);
        return `${mins}:${secs.toString().padStart(2, '0')}`;
    }

    function loadSong(index) {
        const row = songRows[index];
        const songUrl = row.getAttribute('data-song-url');
        const songName = row.getAttribute('data-song-name');
        const movie = row.getAttribute('data-movie');
        const artist = row.getAttribute('data-artist');
        const duration = row.getAttribute('data-duration');
        const image = row.getAttribute('data-image');

        // Update player UI
        document.getElementById('player-image').src = image;
        document.getElementById('player-song-name').textContent = songName;
        document.getElementById('player-movie').textContent = movie;
        document.getElementById('player-artist').textContent = artist;
        // document.getElementById('player-duration').textContent = duration;

        // Load audio
        audio.src = songUrl;
        
        // Show player container
        playerContainer.style.display = 'block';

        // Highlight current song
        songRows.forEach(r => r.classList.remove('active-song'));
        row.classList.add('active-song');

        currentSongIndex = index;
    }

    function getRandomSongIndex() {
        let randomIndex;
        do {
            randomIndex = Math.floor(Math.random() * songRows.length);
        } while (randomIndex === currentSongIndex && songRows.length > 1);
        return randomIndex;
    }

    // Click on song row to play
    songRows.forEach((row, index) => {
        row.addEventListener('click', function(e) {
            if (!e.target.closest('.remove-btn')) {
                loadSong(index);
                audio.play();
            }
        });
    });

    // Play/Pause
    playPauseBtn.addEventListener('click', function() {
        if (currentSongIndex === -1) {
            loadSong(0);
        }
        
        if (isPlaying) {
            audio.pause();
        } else {
            audio.play();
        }
    });

    audio.addEventListener('play', function() {
        isPlaying = true;
        playIcon.style.display = 'none';
        pauseIcon.style.display = 'block';
        status.textContent = "Now Playing";
        status.classList.remove("text-warning", "text-info");
        status.classList.add("text-success");
    });

    audio.addEventListener('pause', function() {
        isPlaying = false;
        playIcon.style.display = 'block';
        pauseIcon.style.display = 'none';
        status.textContent = "Paused";
        status.classList.remove("text-success");
        status.classList.add("text-info");
    });

    audio.addEventListener('timeupdate', function() {
        if (!isSeeking) {
            const progress = (audio.currentTime / audio.duration) * 100;
            progressBar.value = progress || 0;
            progressFill.style.width = (progress || 0) + '%';
            currentTimeDisplay.textContent = formatTime(audio.currentTime);
        }
    });

    audio.addEventListener('loadedmetadata', function() {
        totalTimeDisplay.textContent = formatTime(audio.duration);
        status.textContent = "Ready to Play";
        status.classList.remove("text-success", "text-info");
        status.classList.add("text-warning");
    });

    progressBar.addEventListener('input', function() {
        isSeeking = true;
        const seekTime = (progressBar.value / 100) * audio.duration;
        progressFill.style.width = progressBar.value + '%';
        currentTimeDisplay.textContent = formatTime(seekTime);
    });

    progressBar.addEventListener('change', function() {
        const seekTime = (progressBar.value / 100) * audio.duration;
        audio.currentTime = seekTime;
        isSeeking = false;
    });

     // ============ LOOP BUTTON FUNCTIONALITY ============
    loopBtn.addEventListener('click', function() {
        isLoopOn = !isLoopOn;
        sessionStorage.setItem('loopMode', isLoopOn);
        audio.loop = isLoopOn;
        
        if (isLoopOn) {
            loopBtn.classList.add('active');
            loopBtn.title = 'Loop: ON';
        } else {
            loopBtn.classList.remove('active');
            loopBtn.title = 'Loop: OFF';
        }
    });

    // Shuffle
    shuffleBtn.addEventListener('click', function() {
        isShuffleOn = !isShuffleOn;
        sessionStorage.setItem('shuffleMode', isShuffleOn);
        if (isShuffleOn) {
            shuffleBtn.classList.add('active');
            shuffleBtn.title = 'Shuffle: ON';
        } else {
            shuffleBtn.classList.remove('active');
            shuffleBtn.title = 'Shuffle: OFF';
        }
    });

    // Previous
    prevBtn.addEventListener('click', function() {
        if (currentSongIndex === -1) return;
        
        let newIndex;
        if (isShuffleOn) {
            newIndex = getRandomSongIndex();
        } else {
            newIndex = currentSongIndex > 0 ? currentSongIndex - 1 : songRows.length - 1;
        }
        loadSong(newIndex);
        audio.play();
    });

    // Next
    nextBtn.addEventListener('click', function() {
        if (currentSongIndex === -1) return;
        
        let newIndex;
        if (isShuffleOn) {
            newIndex = getRandomSongIndex();
        } else {
            newIndex = currentSongIndex < songRows.length - 1 ? currentSongIndex + 1 : 0;
        }
        loadSong(newIndex);
        audio.play();
    });

    // Auto-play next
    audio.addEventListener('ended', function() {
        if (!isLoopOn) {
            let newIndex;
            if (isShuffleOn) {
                newIndex = getRandomSongIndex();
            } else {
                newIndex = currentSongIndex < songRows.length - 1 ? currentSongIndex + 1 : 0;
            }
            loadSong(newIndex);
            audio.play();
        }
    });

    let songIdToDelete = null;
    let rowToDelete = null;
    const deleteModal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));
    
    document.querySelectorAll('.remove-btn').forEach(button => {
        button.addEventListener('click', function(e) {
            e.stopPropagation();
            
            songIdToDelete = this.getAttribute('data-song-id');
            const songName = this.getAttribute('data-song-name');
            rowToDelete = this.closest('tr');
            
            // document.getElementById('songToDelete').textContent = `"${songName}"`;
            deleteModal.show();
        });
    });
    
    document.getElementById('confirmDeleteBtn').addEventListener('click', function() {
        const csrftoken = getCookie('csrftoken');
        
        fetch('/toggle-favourite/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': csrftoken
            },
            body: `song_id=${songIdToDelete}`
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                deleteModal.hide();
                
                rowToDelete.style.transition = 'opacity 0.3s';
                rowToDelete.style.opacity = '0';
                
                setTimeout(() => {
                    rowToDelete.remove();
                    
                    const badge = document.querySelector('.badge');
                    const remainingRows = document.querySelectorAll('tbody tr').length;
                    if (badge) {
                        badge.textContent = `${remainingRows} song${remainingRows !== 1 ? 's' : ''}`;
                    }
                    
                    if (remainingRows === 0) {
                        location.reload();
                    } else {
                        const updatedRows = document.querySelectorAll('.song-row');
                        if (currentSongIndex >= updatedRows.length) {
                            currentSongIndex = updatedRows.length - 1;
                        }
                    }
                }, 300);
            } else {
                deleteModal.hide();
                alert(data.message || 'Error removing from wishlist');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            deleteModal.hide();
            alert('Error removing from wishlist. Please try again.');
        });
    });
});
</script>

{% endblock content %}